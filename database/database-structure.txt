CREATE TABLE public.users (
	id uuid DEFAULT gen_random_uuid() NOT NULL,
	name varchar(100) NOT NULL,
	email varchar(150) NOT NULL,
	"password" text NOT NULL,
	created_at timestamp DEFAULT CURRENT_TIMESTAMP NULL,
	updated_at timestamp DEFAULT CURRENT_TIMESTAMP NULL,
	username varchar(50) NOT NULL,
	CONSTRAINT users_email_key UNIQUE (email),
	CONSTRAINT users_pkey PRIMARY KEY (id),
	CONSTRAINT users_username_key UNIQUE (username)
);

CREATE TABLE public.tasks (
	id uuid DEFAULT gen_random_uuid() NOT NULL,
	title varchar(150) NOT NULL,
	description text NOT NULL,
	status varchar(20) DEFAULT 'pending'::character varying NOT NULL,
	created_at timestamp DEFAULT CURRENT_TIMESTAMP NULL,
	updated_at timestamp DEFAULT CURRENT_TIMESTAMP NULL,
	deleted_at timestamp NULL,
	CONSTRAINT status_valid CHECK (((status)::text = ANY ((ARRAY['pending'::character varying, 'in_progress'::character varying, 'completed'::character varying])::text[]))),
	CONSTRAINT tasks_pkey PRIMARY KEY (id)
);

CREATE TABLE public.user_tasks (
	user_id uuid NOT NULL,
	task_id uuid NOT NULL,
	"role" varchar(20) DEFAULT 'owner'::character varying NULL,
	assigned_at timestamp DEFAULT CURRENT_TIMESTAMP NULL,
	created_at timestamp DEFAULT CURRENT_TIMESTAMP NULL,
	updated_at timestamp DEFAULT CURRENT_TIMESTAMP NULL,
	CONSTRAINT role_valid CHECK (((role)::text = ANY ((ARRAY['owner'::character varying, 'collaborator'::character varying])::text[]))),
	CONSTRAINT user_tasks_pkey PRIMARY KEY (user_id, task_id),
	CONSTRAINT user_tasks_task_id_fkey FOREIGN KEY (task_id) REFERENCES public.tasks(id) ON DELETE CASCADE,
	CONSTRAINT user_tasks_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE
);

-- Constraint for valid task statuses
ALTER TABLE tasks
ADD CONSTRAINT status_valid
CHECK (status IN ('pending', 'in_progress', 'completed'));

-- Constraint for valid roles in user_tasks
ALTER TABLE user_tasks
ADD CONSTRAINT role_valid
CHECK (role IN ('owner', 'collaborator'));

-- Optional: Indexes for performance
CREATE INDEX idx_user_tasks_user ON user_tasks(user_id);
CREATE INDEX idx_user_tasks_task ON user_tasks(task_id);
CREATE INDEX idx_tasks_status ON tasks(status);
